<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Emoji Bounce ‚Äî Global Leaderboard + Bouncing Video</title>
<style>
  html,body{height:100%;margin:0;font-family:system-ui,Segoe UI,Roboto,sans-serif;color:#fff;overflow:hidden;background:#000}
  /* Arka plan resmi */
  body::before{
    content:""; position:fixed; inset:0; z-index:0;
    background:url("bg.jpg") center/cover no-repeat fixed;
  }
  body::after{
    content:""; position:fixed; inset:0; z-index:1;
    background:radial-gradient(ellipse at center, rgba(0,0,0,.2) 0%, rgba(0,0,0,.5) 70%, rgba(0,0,0,.8) 100%);
    pointer-events:none;
  }

  /* Zƒ±playan video */
  #bgvid{
    position:fixed; z-index:0; pointer-events:none;
    width:40vw; height:auto; max-width:100%; background:#000;
    left:0; top:0;
  }
  .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:1 }

  /* Oyun alanƒ± */
  #gameCanvas{ position:fixed; inset:0; z-index:2; display:none; }

  .card{
    position:relative; z-index:3; max-width:820px; margin:22px auto; padding:26px;
    background:rgba(0,0,0,.55); border-radius:18px; text-align:center;
  }
  h1{margin:0 0 8px}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0}
  .box{background:rgba(255,255,255,.10);padding:14px;border-radius:12px}
  .num{font-size:32px;font-weight:800}
  .lbl{font-size:12px;opacity:.85}

  .controls{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:12px}
  .btn{background:#fff;color:#111;font-weight:800;border:none;border-radius:999px;padding:10px 14px;cursor:pointer}
  .btn:active{transform:scale(.98)}

  #startOverlay{position:fixed;inset:0;z-index:6;display:grid;place-items:center;background:rgba(0,0,0,.55)}
  #startOverlay button{font-size:16px;font-weight:900;padding:14px 18px;border-radius:999px;border:none;cursor:pointer}

  /* Modal (Game Over + Username) */
  .modal{position:fixed;inset:0;z-index:7;display:none;background:rgba(0,0,0,.55);align-items:center;justify-content:center}
  .modal-card{background:rgba(0,0,0,.78);border-radius:16px;padding:22px;width:min(90vw,380px);text-align:center}
  .actions{display:flex;gap:10px;justify-content:center;margin-top:12px}
  .field{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .input{padding:10px 12px;border-radius:10px;border:none;outline:none;width:60%}
  .note{opacity:.8;font-size:12px;margin-top:6px}

  /* Top3 tablo */
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{padding:8px 10px;text-align:left}
  th{opacity:.8}
  tr:nth-child(even){background:rgba(255,255,255,.05)}
</style>
</head>
<body>
  <video id="bgvid" preload="auto" muted playsinline loop>
    <source src="video.mp4" type="video/mp4">
  </video>
  <div class="overlay"></div>

  <main class="card" aria-live="polite">
    <h1>Emoji Bounce ‚è≥</h1>
    <section class="grid" aria-label="Countdown">
      <div class="box"><div id="d" class="num">‚Äì</div><div class="lbl">Days</div></div>
      <div class="box"><div id="h" class="num">‚Äì</div><div class="lbl">Hours</div></div>
      <div class="box"><div id="m" class="num">‚Äì</div><div class="lbl">Minutes</div></div>
      <div class="box"><div id="s" class="num">‚Äì</div><div class="lbl">Seconds</div></div>
    </section>

    <div class="controls">
      <button id="musicToggle" class="btn">Play Music</button>
      <button id="musicMute" class="btn">Unmute</button>
    </div>

    <button id="playGameBtn" class="btn" style="margin-top:16px;display:none">Play Game</button>
    <p style="opacity:.85;margin:.4rem 0 0">Double tap/click also starts the game. Single tap = fireworks üéÜ</p>

    <h3 style="margin:16px 0 6px">Top 3 (Global)</h3>
    <table id="top3"><thead><tr><th>#</th><th>Name</th><th>Best</th></tr></thead><tbody></tbody></table>
  </main>

  <canvas id="gameCanvas"></canvas>

  <!-- Username Modal -->
  <div id="nameModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h2>Enter a unique username</h2>
      <div class="field">
        <input id="nameInput" class="input" type="text" maxlength="20" placeholder="Your name">
        <button id="nameOk" class="btn">OK</button>
      </div>
      <div id="nameErr" class="note" style="color:#ffabab;display:none">This name is taken. Try another.</div>
      <div class="note">Global leaderboard. One name per person.</div>
    </div>
  </div>

  <!-- Game Over -->
  <div id="gameOver" class="modal" aria-hidden="true">
    <div class="modal-card">
      <h2>Game Over</h2>
      <p>Score: <span id="finalScore">0</span></p>

      <h3 style="margin:.5rem 0 0">Top 3 (Global)</h3>
      <table id="top3GO"><thead><tr><th>#</th><th>Name</th><th>Best</th></tr></thead><tbody id="top3Body"></tbody></table>

      <div class="actions">
        <button id="playAgainBtn" class="btn">Play Again</button>
        <button id="exitGameBtn" class="btn">Exit</button>
      </div>
    </div>
  </div>

  <!-- Start -->
  <div id="startOverlay">
    <button id="startBtn">Start (enable sound)</button>
  </div>

  <audio id="bgmusic" loop>
    <source src="music.mp3" type="audio/mpeg">
  </audio>

  <!-- Firebase compat SDK'larƒ± -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <!-- Konfeti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<script>
/* ========== Firebase: senin projen ========== */
const firebaseConfig = {
  apiKey: "AIzaSyApHBkUOMJ1EDgudFVAE44d0vCLR0542v4",
  authDomain: "palermo-39690.firebaseapp.com",
  projectId: "palermo-39690",
  storageBucket: "palermo-39690.firebasestorage.app",
  messagingSenderId: "801382190611",
  appId: "1:801382190611:web:9e000b5d32382a2f9e79e6",
  measurementId: "G-CMMBQYTLC7"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
let _authed=false;
auth.signInAnonymously().then(()=>_authed=true).catch(console.error);

/* ========== Helpers & State ========== */
function $(s){return document.querySelector(s)}
const els = {
  d: $("#d"), h: $("#h"), m: $("#m"), s: $("#s"),
  vid: $("#bgvid"),
  music: $("#bgmusic"),
  musicToggle: $('#musicToggle'), musicMute: $('#musicMute'),
  startOverlay: $('#startOverlay'), startBtn: $('#startBtn'),
  playGameBtn: $('#playGameBtn'),
  gameCanvas: $('#gameCanvas'),
  gameOver: $('#gameOver'), finalScore: $('#finalScore'),
  playAgainBtn: $('#playAgainBtn'), exitGameBtn: $('#exitGameBtn'),
  nameModal: $('#nameModal'), nameInput: $('#nameInput'), nameOk: $('#nameOk'), nameErr: $('#nameErr'),
  top3Body: document.querySelector('#top3Body'),
  top3TableOnMain: document.querySelector('#top3 tbody')
};

const DEVICE = (()=>{ const ua=navigator.userAgent||""; return {
  isAndroid:/Android/i.test(ua),
  isIOS:/iPhone|iPad|iPod/i.test(ua)
};})();
// hƒ±z normalize: Android hƒ±zlƒ± geliyordu ‚Üí %90, iOS yava≈ü ‚Üí %110
const deviceFactor = DEVICE.isAndroid ? 0.90 : DEVICE.isIOS ? 1.10 : 1.00;

/* ========== Countdown ========== */
const DEADLINE = new Date("2025-10-07T23:59:59");
function pad(n){return String(n).padStart(2,"0")}
function tick(){
  const now=new Date(); let diff=Math.max(0,DEADLINE-now);
  if(diff<=0){
    els.d.textContent=els.h.textContent=els.m.textContent=els.s.textContent="00";
    confetti({particleCount:200,spread:70,origin:{y:0.6}});
  }else{
    const d=Math.floor(diff/86400000); diff-=d*86400000;
    const h=Math.floor(diff/3600000); diff-=h*3600000;
    const m=Math.floor(diff/60000); diff-=m*60000;
    const s=Math.floor(diff/1000);
    els.d.textContent=d; els.h.textContent=pad(h); els.m.textContent=pad(m); els.s.textContent=pad(s);
  }
}
tick(); setInterval(tick,1000);

/* ========== Music ========== */
let playing=false;
els.musicToggle.onclick=()=>{ if(!playing){ els.music.play(); playing=true; } else { els.music.pause(); playing=false; } };
els.musicMute.onclick=()=>{ els.music.muted=!els.music.muted };

/* ========== Start overlay ========== */
els.startBtn.onclick=async()=>{
  try{ await els.music.play(); playing=true; els.music.muted=false; }catch(e){}
  try{ await els.vid.play(); }catch(e){}
  els.startOverlay.style.display="none";
  els.playGameBtn.style.display="inline-block";
};

/* ========== Bouncing video (devam) ========== */
let posX=0,posY=0,vx=2,vy=1.5;
function moveVid(){
  const vw=els.vid.offsetWidth||200, vh=els.vid.offsetHeight||150;
  const bw=innerWidth,bh=innerHeight;
  posX+=vx; posY+=vy;
  if(posX<=0){posX=0;vx=Math.abs(vx);}
  if(posX+vw>=bw){posX=bw-vw;vx=-Math.abs(vx);}
  if(posY<=0){posY=0;vy=Math.abs(vy);}
  if(posY+vh>=bh){posY=bh-vh;vy=-Math.abs(vy);}
  els.vid.style.left=posX+"px"; els.vid.style.top=posY+"px";
  requestAnimationFrame(moveVid);
}
requestAnimationFrame(moveVid);

/* ========== Game ========== */
const canvas=els.gameCanvas, ctx=canvas.getContext('2d');
function resize(){ canvas.width=innerWidth; canvas.height=innerHeight; } resize(); addEventListener('resize',resize);

let gameOn=false, score=0, currentUser=null, over=false;
const ball = { x:0, y:0, r:28, vx:3, vy:-6, mul:0.5, maxMul:5, emoji:'ü§û' }; // max 5
const paddle = { w:140, h:16, x:0, y:0 };

function resetGame(){
  if(!currentUser){ askName(); return; }
  gameOn=true; over=false; score=0;
  ball.x=canvas.width*0.5; ball.y=canvas.height*0.35;
  ball.vx=3; ball.vy=-6; ball.mul=0.5 * deviceFactor;  // normalize
  paddle.x=canvas.width*0.5 - paddle.w/2; paddle.y=canvas.height-80;
  canvas.style.display='block';
  els.gameOver.style.display='none'; els.gameOver.setAttribute('aria-hidden','true');
}
function endGame(){
  gameOn=false; over=true;
  els.finalScore.textContent = String(score);
  // skor kaydƒ± + top3 (GLOBAL Firestore)
  saveScore(currentUser, score).then(({isTop3,isPB})=>{
    renderTop3().then(()=>{ // hem modal i√ßindeki, hem ana sayfadaki tabloyu g√ºncelle
      renderTop3OnMain();
      els.gameOver.style.display='flex'; els.gameOver.setAttribute('aria-hidden','false');
      if(isTop3 || isPB) celebrateFireworks();
    });
  });
}

/* --- Username (global unique) --- */
function askName(){
  els.nameInput.value='';
  els.nameErr.style.display='none';
  els.nameModal.style.display='flex'; els.nameModal.setAttribute('aria-hidden','false');
  setTimeout(()=>els.nameInput.focus(),50);
}
function closeNameModal(){
  els.nameModal.style.display='none'; els.nameModal.setAttribute('aria-hidden','true');
}
els.nameOk.onclick=async()=>{
  const name = (els.nameInput.value||'').trim();
  if(!name){ els.nameErr.textContent='Please enter a name.'; els.nameErr.style.display='block'; return; }
  if(!_authed){ els.nameErr.textContent='Connecting...'; els.nameErr.style.display='block'; return; }
  const ok = await isNameAvailable(name);
  if(!ok){ els.nameErr.textContent='This name is taken. Try another.'; els.nameErr.style.display='block'; return; }
  await registerName(name);
  currentUser = name;
  closeNameModal();
  resetGame();
};
els.playGameBtn.onclick=()=>{ if(!currentUser){ askName(); } else { resetGame(); } };
document.addEventListener('dblclick',()=>{ if(!currentUser){ askName(); } else { resetGame(); } });
let lastTap=0; document.addEventListener('touchend',()=>{ const now=Date.now(); if(now-lastTap<350){ if(!currentUser){ askName(); } else { resetGame(); } } lastTap=now; });

/* --- Firestore GLOBAL: usernames + scores --- */
// ƒ∞Sƒ∞M benzersiz mi?
async function isNameAvailable(name){
  const id = name.toLowerCase();
  const ref = db.collection('users').doc(id);
  const snap = await ref.get();
  return !snap.exists;
}
// ƒ∞sim kaydƒ±
async function registerName(name){
  const id = name.toLowerCase();
  const ref = db.collection('users').doc(id);
  await ref.set({
    name, best: 0,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge: false });
}
// Skoru kaydet (best)
async function saveScore(name, sc){
  const id = (name||'').toLowerCase();
  if(!id) return { isPB:false, isTop3:false };
  const ref = db.collection('users').doc(id);
  const snap = await ref.get();
  let isPB=false;
  if(!snap.exists){
    await ref.set({
      name, best: sc,
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    });
    isPB=true;
  }else{
    const cur = snap.data().best || 0;
    if(sc > cur){
      await ref.update({ best: sc, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
      isPB=true;
    }
  }
  // isTop3?
  const top = await db.collection('users').orderBy('best','desc').limit(3).get();
  const names = top.docs.map(d=> (d.data().name || d.id).toLowerCase());
  const isTop3 = names.includes(id);
  return { isPB, isTop3 };
}
// Top3 doldur (modal)
async function renderTop3(){
  const qs = await db.collection('users').orderBy('best','desc').limit(3).get();
  let i=0, html="";
  qs.forEach(docu=>{
    const d=docu.data(); i++;
    html += `<tr><td>${i}</td><td>${d.name || docu.id}</td><td>${d.best||0}</td></tr>`;
  });
  els.top3Body.innerHTML = html || '<tr><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td></tr>';
}
// Top3 doldur (ana sayfa)
async function renderTop3OnMain(){
  const qs = await db.collection('users').orderBy('best','desc').limit(3).get();
  let i=0, html="";
  qs.forEach(docu=>{
    const d=docu.data(); i++;
    html += `<tr><td>${i}</td><td>${d.name || docu.id}</td><td>${d.best||0}</td></tr>`;
  });
  els.top3TableOnMain.innerHTML = html || '<tr><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td></tr>';
}

/* --- Fireworks --- */
const sparks=[];
function spawnFirework(x,y,count=35){
  for(let i=0;i<count;i++){
    const a=Math.random()*Math.PI*2, sp=2+Math.random()*4;
    sparks.push({x,y, vx:Math.cos(a)*sp, vy:Math.sin(a)*sp, life:40+Math.random()*20});
  }
}
function celebrateFireworks(){
  for(let i=0;i<3;i++){
    const x = Math.random()*canvas.width;
    const y = Math.random()*canvas.height*0.6;
    spawnFirework(x,y,60);
  }
}
function stepFireworks(){
  for(let i=sparks.length-1;i>=0;i--){
    const p=sparks[i]; p.x+=p.vx; p.y+=p.vy; p.vy+=0.05; p.life-=1;
    if(p.life<=0) sparks.splice(i,1);
  }
}
function drawFireworks(){
  ctx.save(); ctx.globalCompositeOperation='lighter';
  for(const p of sparks){
    const alpha=Math.max(0, p.life/60);
    ctx.fillStyle=`rgba(255,255,255,${alpha})`;
    ctx.beginPath(); ctx.arc(p.x,p.y,2,0,Math.PI*2); ctx.fill();
  }
  ctx.restore();
}
addEventListener('click', e=>{ if(gameOn && !over) spawnFirework(e.clientX, e.clientY, 35); });

/* --- Input --- */
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function movePaddleTo(x){ paddle.x = clamp(x - paddle.w/2, 0, canvas.width - paddle.w); }
canvas.addEventListener('mousemove', e=> movePaddleTo(e.clientX));
canvas.addEventListener('touchmove', e=>{ movePaddleTo(e.touches[0].clientX); e.preventDefault(); }, {passive:false});

/* --- Game Loop & Physics --- */
function drawEmoji(e,x,y){ ctx.font=`${ball.r*2}px serif`; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(e,x,y); }
function drawPaddle(){ ctx.fillStyle='rgba(255,255,255,.95)'; ctx.fillRect(paddle.x, paddle.y, paddle.w, paddle.h); }

function loop(){
  requestAnimationFrame(loop);
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(gameOn){
    // hareket
    ball.x += ball.vx * ball.mul;
    ball.y += ball.vy * ball.mul;

    // duvarlar
    if(ball.x-ball.r<=0){ ball.x=ball.r; ball.vx=Math.abs(ball.vx); }
    if(ball.x+ball.r>=canvas.width){ ball.x=canvas.width-ball.r; ball.vx=-Math.abs(ball.vx); }
    if(ball.y-ball.r<=0){ ball.y=ball.r; ball.vy=Math.abs(ball.vy); }

    // paddle
    drawPaddle();

    // √ßarpƒ±≈üma (paddle)
    if(ball.y+ball.r >= paddle.y && ball.x >= paddle.x && ball.x <= paddle.x+paddle.w && ball.vy>0){
      // temel yansƒ±ma
      ball.vy = -Math.abs(ball.vy);
      // vuru≈ü noktasƒ±na g√∂re a√ßƒ±: merkezden uzaklƒ±ƒüa g√∂re yatay hƒ±z deƒüi≈üikliƒüi
      const hitPos = (ball.x - (paddle.x + paddle.w/2)) / (paddle.w/2); // -1..1
      ball.vx += hitPos * 1.5; // kontrol edilebilir sapma
      // rastgele k√º√ß√ºk sapma (predictable olmasƒ±n)
      ball.vx += (Math.random()*2 - 1) * 0.7;

      // hƒ±z artƒ±≈üƒ± (kademeli + normalize, max 5)
      ball.mul = Math.min(ball.maxMul, ball.mul + 0.10 * deviceFactor);

      score++;
      spawnFirework(ball.x, paddle.y, 20);
    }

    // yere d√º≈üt√º ‚Üí bitir
    if(ball.y - ball.r > canvas.height){ endGame(); }

    // top
    drawEmoji(ball.emoji, ball.x, ball.y);
  }

  // fireworks
  stepFireworks(); drawFireworks();

  // skor g√∂sterimi
  if(gameOn){
    ctx.fillStyle='rgba(255,255,255,.9)';
    ctx.font='bold 16px system-ui, sans-serif';
    ctx.fillText(`Score: ${score}`, 12, 22);
    ctx.fillText(`Player: ${currentUser || "-"}`, 12, 42);
  }
}
requestAnimationFrame(loop);

/* --- Buttons --- */
els.playAgainBtn.onclick=()=> resetGame();
function exitGame(){
  els.gameOver.style.display='none'; els.gameOver.setAttribute('aria-hidden','true');
  canvas.style.display='none'; gameOn=false; over=false; score=0;
}
els.exitGameBtn.onclick=()=> exitGame();
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ exitGame(); } });

/* --- Load Top3 on load (main table) --- */
renderTop3OnMain();
</script>
</body>
</html>
